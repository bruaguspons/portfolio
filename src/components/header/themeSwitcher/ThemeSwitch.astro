---
interface Props {
    defaultTheme?: "dark" | "light" | "system";
}

const { defaultTheme } = Astro.props;
---

<button
    class="bg-background-100 dark:bg-background-600 border-black dark:border-background-100 text-background-600 dark:text-background-100 hover:bg-background-200 dark:hover:bg-background-500 transition duration-150 px-3 py-1 rounded-lg flex gap-2 items-center border"
    id="astro-color-scheme-switch"
    aria-label="Theme Switch"
>
    <slot />
</button>

<style>
    :global(.dark) {
        color-scheme: dark;
    }
</style>

<script define:vars={{ defaultTheme }}>
    const themeMatcher = window.matchMedia("(prefers-color-scheme: dark)");
    const systemTheme = themeMatcher.matches ? "dark" : "light";

    const updateAppliedTheme = (value) => {
        document.documentElement.classList.remove("light", "dark");
        document.documentElement.classList.add(value);
        document.documentElement.setAttribute("data-theme", value);
    };

    const updateTheme = (value) => {
        const theme = value === "system" ? systemTheme : value;
        updateAppliedTheme(theme);
        localStorage.setItem("theme", value);
    };

    const getTheme = () => {
        if (
            typeof localStorage !== "undefined" &&
            localStorage.getItem("theme")
        ) {
            return localStorage.getItem("theme");
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            return "dark";
        }
        return defaultTheme;
    };

    const handleClick = (element) => {
        element.addEventListener("click", (event) => {
            const theme = getTheme();
            const settheme = theme === "dark" ? "light" : "dark";
            updateTheme(settheme);
        });
    };

    const element = document.getElementById("astro-color-scheme-switch");

    updateTheme(getTheme());
    handleClick(element);
    document.addEventListener("astro:after-swap", () => {
        const element = document.getElementById("astro-color-scheme-switch");
        updateTheme(getTheme());
        handleClick(element);
    });
</script>
